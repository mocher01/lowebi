<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Admin Buttons</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; } .error { color: red; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>üêõ Admin Dashboard Button Debug Tool</h1>
    
    <div x-data="debugApp()" x-init="init()">
        
        <div class="test-section">
            <h2>1. Authentication Test</h2>
            <button @click="testLogin()">Test Login</button>
            <div x-text="authStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>2. Token Validation</h2>
            <div>Current Token: <span x-text="token ? 'Present' : 'Missing'"></span></div>
            <div x-show="tokenInfo" x-text="tokenInfo"></div>
        </div>
        
        <div class="test-section">
            <h2>3. API Endpoint Tests</h2>
            <button @click="testAssignEndpoint()">Test Assign API</button>
            <button @click="testViewEndpoint()">Test View API</button>
            <button @click="testStartEndpoint()">Test Start API</button>
            <div x-text="apiResults"></div>
        </div>
        
        <div class="test-section">
            <h2>4. Queue Data Test</h2>
            <button @click="testLoadQueue()">Load Queue</button>
            <div x-text="queueStatus"></div>
            <div x-show="queueData.length > 0">
                <h3>First Request:</h3>
                <template x-for="request in queueData.slice(0,1)">
                    <div>
                        <p>ID: <span x-text="request.id"></span></p>
                        <p>Status: <span x-text="request.status"></span></p>
                        <p>Admin ID: <span x-text="request.admin_id"></span></p>
                        <p>User ID: <span x-text="user?.id"></span></p>
                        <button @click="testAssignRequest(request.id)">Test Assign</button>
                        <button @click="testViewRequest(request.id)">Test View</button>
                        <button @click="testStartRequest(request.id)" x-show="request.status === 'assigned' && request.admin_id === user?.id">Test Start</button>
                    </div>
                </template>
            </div>
        </div>
        
        <div class="test-section">
            <h2>5. Console Logs</h2>
            <div x-html="logs"></div>
        </div>
        
    </div>

    <script>
        function debugApp() {
            return {
                token: localStorage.getItem('admin_token'),
                user: null,
                authStatus: 'Not tested',
                tokenInfo: '',
                apiResults: '',
                queueStatus: 'Not loaded',
                queueData: [],
                logs: '',
                
                init() {
                    this.log('üîß Debug tool initialized');
                    if (this.token) {
                        this.decodeToken();
                    }
                },
                
                log(message) {
                    const timestamp = new Date().toLocaleTimeString();
                    this.logs += `<div>[${timestamp}] ${message}</div>`;
                    console.log(message);
                },
                
                async testLogin() {
                    this.log('üîê Testing login...');
                    try {
                        const response = await fetch('/admin/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: 'admin@locod.ai',
                                password: 'admin123'
                            })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            this.token = data.token;
                            this.user = data.user;
                            localStorage.setItem('admin_token', this.token);
                            this.authStatus = '‚úÖ Login successful';
                            this.log('‚úÖ Login successful');
                            this.decodeToken();
                        } else {
                            this.authStatus = '‚ùå Login failed: ' + data.message;
                            this.log('‚ùå Login failed: ' + data.message);
                        }
                    } catch (error) {
                        this.authStatus = '‚ùå Login error: ' + error.message;
                        this.log('‚ùå Login error: ' + error.message);
                    }
                },
                
                decodeToken() {
                    if (this.token) {
                        try {
                            const payload = JSON.parse(atob(this.token.split('.')[1]));
                            this.user = payload;
                            this.tokenInfo = `User: ${payload.email}, Expires: ${new Date(payload.exp * 1000)}`;
                            this.log('üé´ Token decoded: ' + payload.email);
                        } catch (error) {
                            this.tokenInfo = '‚ùå Invalid token';
                            this.log('‚ùå Token decode error: ' + error.message);
                        }
                    }
                },
                
                async testAssignEndpoint() {
                    this.log('üìã Testing assign endpoint...');
                    try {
                        const response = await fetch('/admin/queue/23/assign', {
                            method: 'PUT',
                            headers: { 
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        const data = await response.json();
                        this.apiResults = `Assign: ${response.ok ? '‚úÖ' : '‚ùå'} - ${JSON.stringify(data)}`;
                        this.log('üìã Assign result: ' + JSON.stringify(data));
                    } catch (error) {
                        this.apiResults = '‚ùå Assign error: ' + error.message;
                        this.log('‚ùå Assign error: ' + error.message);
                    }
                },
                
                async testViewEndpoint() {
                    this.log('üëÅÔ∏è Testing view endpoint...');
                    try {
                        const response = await fetch('/admin/queue/23', {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        const data = await response.json();
                        this.apiResults = `View: ${response.ok ? '‚úÖ' : '‚ùå'} - Site: ${data.request_data?.siteName || 'N/A'}`;
                        this.log('üëÅÔ∏è View result: ' + (data.request_data?.siteName || 'No site name'));
                    } catch (error) {
                        this.apiResults = '‚ùå View error: ' + error.message;
                        this.log('‚ùå View error: ' + error.message);
                    }
                },
                
                async testStartEndpoint() {
                    this.log('üöÄ Testing start endpoint...');
                    try {
                        const response = await fetch('/admin/queue/23/start', {
                            method: 'PUT',
                            headers: { 
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        const data = await response.json();
                        this.apiResults = `Start: ${response.ok ? '‚úÖ' : '‚ùå'} - ${JSON.stringify(data)}`;
                        this.log('üöÄ Start result: ' + JSON.stringify(data));
                    } catch (error) {
                        this.apiResults = '‚ùå Start error: ' + error.message;
                        this.log('‚ùå Start error: ' + error.message);
                    }
                },
                
                async testLoadQueue() {
                    this.log('üìä Testing queue loading...');
                    try {
                        const response = await fetch('/admin/queue', {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        const data = await response.json();
                        if (response.ok) {
                            this.queueData = data.requests || [];
                            this.queueStatus = `‚úÖ Loaded ${this.queueData.length} requests`;
                            this.log(`üìä Queue loaded: ${this.queueData.length} requests`);
                        } else {
                            this.queueStatus = '‚ùå Failed to load queue';
                            this.log('‚ùå Queue load failed: ' + JSON.stringify(data));
                        }
                    } catch (error) {
                        this.queueStatus = '‚ùå Queue error: ' + error.message;
                        this.log('‚ùå Queue error: ' + error.message);
                    }
                },
                
                async testAssignRequest(requestId) {
                    this.log(`üìã Testing assign for request ${requestId}...`);
                    try {
                        const response = await fetch(`/admin/queue/${requestId}/assign`, {
                            method: 'PUT',
                            headers: { 
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        const data = await response.json();
                        this.log(`üìã Assign ${requestId}: ${response.ok ? '‚úÖ' : '‚ùå'} - ${JSON.stringify(data)}`);
                        if (response.ok) {
                            await this.testLoadQueue(); // Reload to see changes
                        }
                    } catch (error) {
                        this.log(`‚ùå Assign ${requestId} error: ${error.message}`);
                    }
                },
                
                async testViewRequest(requestId) {
                    this.log(`üëÅÔ∏è Testing view for request ${requestId}...`);
                    try {
                        const response = await fetch(`/admin/queue/${requestId}`, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        const data = await response.json();
                        this.log(`üëÅÔ∏è View ${requestId}: ${response.ok ? '‚úÖ' : '‚ùå'} - Status: ${data.status}`);
                    } catch (error) {
                        this.log(`‚ùå View ${requestId} error: ${error.message}`);
                    }
                },
                
                async testStartRequest(requestId) {
                    this.log(`üöÄ Testing start for request ${requestId}...`);
                    try {
                        const response = await fetch(`/admin/queue/${requestId}/start`, {
                            method: 'PUT',
                            headers: { 
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        const data = await response.json();
                        this.log(`üöÄ Start ${requestId}: ${response.ok ? '‚úÖ' : '‚ùå'} - ${JSON.stringify(data)}`);
                        if (response.ok) {
                            await this.testLoadQueue(); // Reload to see changes
                        }
                    } catch (error) {
                        this.log(`‚ùå Start ${requestId} error: ${error.message}`);
                    }
                }
            }
        }
    </script>
</body>
</html>