# LOGEN v2 Complete Flow Analysis
## From "Create New Site" to AI Generation - Complete Data Flow Documentation

---

## **Complete LOGEN v2 Flow Analysis - From "Create New Site" to AI Generation**

### **Step 1: Initial Entry Point**
*URL: `https://logen.locod-ai.com/sites/create`*
*File: `/var/apps/logen/apps/frontend/src/pages/sites/create.tsx`*

**User Action:** Clicks "Create New Site"
**Available Options:**
- Start with wizard (redirects to `/wizard?new=true`)
- Import existing site
- Create blank site

### **Step 2: Wizard Entry Point**
*URL: `https://logen.locod-ai.com/wizard?new=true`*
*File: `/var/apps/logen/apps/frontend/src/pages/wizard.tsx`*

**Component Initialization:**
- `WizardProvider` component wraps entire wizard flow
- Detects `?new=true` parameter
- Generates new session ID using `generateSessionId()`
- **No database record created yet**

### **Step 3: WizardProvider Session Management** 
*File: `/var/apps/logen/apps/frontend/src/components/wizard/wizard-provider.tsx`*

**Session ID Generation:**
```typescript
const generateSessionId = () => {
  return Math.random().toString(36).substring(2) + Date.now().toString(36);
};
```
**Example:** Session ID = `"k8j2m31h9x4f7p"`
**State Initialization:**
- `sessionId`: Generated string
- `wizardData`: Empty object `{}`  
- `currentStep`: 0

### **Step 4: Step 1 - Welcome Step**
*File: `/var/apps/logen/apps/frontend/src/components/wizard/steps/welcome-step.tsx`*

**Purpose:** Introduction screen
**Data Collection:** None
**User Action:** Click "Commencer" → `nextStep()`

### **Step 5: Step 2 - Template Selection**
*File: `/var/apps/logen/apps/frontend/src/components/wizard/steps/template-selection-step.tsx`*

**Data Collection:**
- `selectedTemplate`: Template object with design preferences
- `businessType`: Category selection (e.g., "Restaurant", "Boutique")

**Local State Update:**
```typescript
setWizardData(prev => ({
  ...prev,
  selectedTemplate: template,
  businessType: template.category
}));
```

**Critical Transition:** Step 2 → Step 3 triggers first backend session creation

### **Step 6: Backend Session Creation (Step 2→3 Transition)**
*File: `/var/apps/logen/apps/frontend/src/components/wizard/wizard-provider.tsx`*

**Function:** `nextStep()` when moving from step 2 to 3
**Backend Call:** `POST /public/wizard-sessions`

**Data Entity Created:** WIZARD_SESSIONS table record
- **Table:** `wizard_sessions`
- **Key Fields:**
  - `id`: UUID (generated by database)
  - `session_id`: String from frontend (e.g., "k8j2m31h9x4f7p")
  - `wizard_data`: JSONB containing all form data
  - `current_step`: 2 (about to move to 3)
  - `user_id`: null (anonymous session)
  - `created_at`: Current timestamp
  - `updated_at`: Current timestamp
  - `last_accessed_at`: Current timestamp

**URL Transition Logic:**
```typescript
// Critical redirect from ?new=true to ?continue=sessionId
if (newStep === 3 && searchParams.get('new') === 'true') {
  const newUrl = `/wizard?continue=${sessionId}`;
  router.replace(newUrl);
}
```

### **Step 7: Step 3 - Business Information**
*File: `/var/apps/logen/apps/frontend/src/components/wizard/steps/business-info-step.tsx`*

**Data Collection:**
- `siteName`: Business name
- `businessDescription`: Description text  
- `businessType`: Refined category
- `city`: Location
- `phone`: Contact number
- `email`: Contact email
- Additional business details

**Backend Updates:** Each form change triggers `POST /public/wizard-sessions/:sessionId/update`
**WIZARD_SESSIONS Record:** `wizard_data` JSONB field updated with form data

### **Step 8: Step 4 - Content Review & AI Generation**
*File: `/var/apps/logen/apps/frontend/src/components/wizard/steps/content-review-step.tsx`*

**Purpose:** Display preview + AI content generation
**Key Functions:**
- `generateCompleteContent()`: Initiates AI request
- `requestAiContent()`: Backend API call
- Display generated content sections

### **Step 9: AI Request Creation**
*File: `/var/apps/logen/apps/frontend/src/components/wizard/wizard-provider.tsx`*

**Function:** `requestAiContent()`
**Backend Call:** `POST /customer/wizard-sessions/:sessionId/ai-request`
**Controller:** `WizardAiRequestController.createAiRequest()`

**Data Preparation:**
```typescript
const aiRequestData: CreateAiRequestDto = {
  customerId: req.user.id,
  siteId: undefined,
  requestType: "COMPLETE_CONTENT",
  businessType: session.businessType || 'Unknown',
  terminology: 'services',
  priority: 'normal',
  requestData: {
    siteName: session.siteName,
    businessType: session.businessType,
    wizardData: session.wizardData || {},
    domain: session.domain,
  },
  wizardSessionId: session.id, // UUID from WIZARD_SESSIONS
  estimatedCost: 2.5,
};
```

### **Step 10: AiQueueService.createRequest() Method**
*File: `/var/apps/logen/apps/backend/src/admin/services/ai-queue.service.ts:62-71`*

**Data Entity Created:** AI_REQUESTS table record
- **Table:** `ai_requests`
- **Key Fields:**
  - `id`: Auto-increment primary key
  - `customerId`: User UUID from JWT token
  - `siteId`: null (wizard requests don't have site ID yet)
  - `requestType`: "COMPLETE_CONTENT" 
  - `businessType`: From wizard session (e.g., "Restaurant")
  - `terminology`: "services"
  - `priority`: "normal"
  - `requestData`: JSONB containing wizard session data
  - `wizardSessionId`: UUID linking to WIZARD_SESSIONS table
  - `estimatedCost`: 2.5
  - **`status`: "PENDING"** ← Critical state
  - `createdAt`: Current timestamp
  - `updatedAt`: Current timestamp

**Function Flow:**
```typescript
// ai-queue.service.ts:62-71
async createRequest(createDto: CreateAiRequestDto): Promise<AiRequest> {
  const request = this.aiRequestRepository.create({
    ...createDto,
    status: RequestStatus.PENDING,  // ← Sets initial state
    createdAt: new Date(),
    updatedAt: new Date(),
  });
  return this.aiRequestRepository.save(request);
}
```

### **Step 11: Frontend Polling Mechanism**
*File: `/var/apps/logen/apps/frontend/src/components/wizard/wizard-provider.tsx`*

**Function:** `pollForAiCompletion()`
- Starts 5-second interval polling
- Calls `GET /customer/wizard-sessions/:sessionId/ai-request/:requestId/status`
- Monitors `aiRequest.status` field from AI_REQUESTS table
- Expected state transition: PENDING → ASSIGNED → PROCESSING → COMPLETED

### **Step 12: Admin Workflow (Manual Processing)**
*File: `/var/apps/logen/apps/backend/src/admin/services/ai-queue.service.ts`*

**Admin Actions on AI_REQUESTS:**
1. **assignRequest()** (line 163): `status: PENDING → ASSIGNED`
2. **startProcessing()** (line 181): `status: ASSIGNED → PROCESSING` 
3. **completeRequest()** (line 203): `status: PROCESSING → COMPLETED`

**Critical Step - AI Content Application:**
*ai-queue.service.ts:237-263*
```typescript
// When admin completes request, content is applied to wizard session
if (request.wizardSessionId && generatedContent) {
  await this.wizardSessionService.applyAiContent(
    request.wizardSessionId,    // ← UUID from AI_REQUESTS
    request.requestType,        // ← "COMPLETE_CONTENT"
    generatedContent,          // ← JSON content from admin
  );
}
```

### **Step 13: Backend AI Content Application**
*File: `/var/apps/logen/apps/backend/src/customer/services/wizard-session.service.ts`*

**Function:** `applyAiContent()` 
**Updates:** WIZARD_SESSIONS table record
```typescript
// Critical database update using QueryBuilder to preserve JSONB
await this.wizardSessionRepository
  .createQueryBuilder()
  .update()
  .set({
    wizardData: updatedWizardData,     // ← Merges AI content into existing data
    updatedAt: () => 'CURRENT_TIMESTAMP',
    lastAccessedAt: () => 'CURRENT_TIMESTAMP'
  })
  .where('id = :id', { id: wizardSessionId })
  .execute();
```

**Data Transformation:**
- Takes existing `wizardData` JSONB from WIZARD_SESSIONS
- Merges in AI-generated content sections (hero, services, about, etc.)
- Updates `wizardData.generatedContent` with full AI response
- Preserves all existing wizard form data

### **Step 14: Frontend Status Polling Success**
*File: `/var/apps/logen/apps/frontend/src/components/wizard/wizard-provider.tsx`*

**Detection:** `aiRequest.status === 'completed'`
**Action:** Calls `refetchWizardSessionData()`

### **Step 15: Frontend Data Refetch Mechanism**
*File: `/var/apps/logen/apps/frontend/src/components/wizard/wizard-provider.tsx`*

**Function:** `refetchWizardSessionData()`
**Endpoint:** `GET /public/wizard-sessions/:sessionId`
**Response:** Updated WIZARD_SESSIONS record with AI content merged into `wizardData`

**Critical State Update:**
```typescript
if (sessionData) {
  setWizardData(sessionData);           // ← Updates React state with AI content
  setCurrentStep(result.session.currentStep || 0);
}
```

### **Step 16: Frontend Display in Step 4**
*File: `/var/apps/logen/apps/frontend/src/components/wizard/steps/content-review-step.tsx`*

**Data Source:** `wizardData` from WizardProvider context
**Display Logic:** Shows AI-generated content sections:
- `wizardData.hero` → Hero section preview
- `wizardData.services` → Services list preview  
- `wizardData.about` → About section preview
- `wizardData.testimonials` → Testimonials preview

---

## **Complete Data Entity Summary**

### **Tables Involved:**
1. **WIZARD_SESSIONS** 
   - `id` (UUID) - Primary session identifier
   - `session_id` (string) - URL session parameter  
   - `wizard_data` (JSONB) - All form data + AI content
   - `current_step` - Step progression tracking
   - `user_id` - Customer association
   - `last_accessed_at` - Session activity

2. **AI_REQUESTS**
   - `id` (auto-increment) - Request identifier
   - `wizard_session_id` (UUID) - Links to WIZARD_SESSIONS.id
   - `customer_id` - User association
   - `status` - PENDING→ASSIGNED→PROCESSING→COMPLETED
   - `request_type` - "COMPLETE_CONTENT"
   - `request_data` (JSONB) - Wizard session data snapshot
   - `generated_content` (JSONB) - AI output from admin

3. **CUSTOMER_SITES** *(Created later in flow)*
   - Only created when wizard is completed/published
   - References completed wizard session data

### **Critical Functions:**
1. **generateCompleteContent()** - Initiates AI request
2. **AiQueueService.createRequest()** - Creates AI_REQUESTS record
3. **AiQueueService.completeRequest()** - Admin completes + applies content
4. **WizardSessionService.applyAiContent()** - Merges AI into WIZARD_SESSIONS
5. **refetchWizardSessionData()** - Syncs backend changes to frontend state

### **Data Flow Timeline:**
```
User Clicks "Générer par IA" 
  ↓
AI_REQUESTS.status = "PENDING" 
  ↓
Admin processes: PENDING → ASSIGNED → PROCESSING → COMPLETED
  ↓
AiQueueService.completeRequest() calls applyAiContent()
  ↓
WIZARD_SESSIONS.wizard_data updated with AI content
  ↓
Frontend polling detects completion → calls refetchWizardSessionData()
  ↓
React state updated → Step 4 displays AI content
```

---

## **Known Issues Identified:**

1. **Frontend Data Synchronization**: AI content successfully applied to database but `refetchWizardSessionData()` not working properly due to authentication/endpoint issues

2. **Frontend State Overwriting**: Frontend updates overwriting AI-generated content with empty data during wizard progression

3. **Continue Flow Authentication**: Continue flow using wrong step due to endpoint path errors (`/api/public/wizard-sessions/` vs `/public/wizard-sessions/`)

4. **Polling Reliability**: Frontend polling mechanism may not detect AI completion status changes reliably

5. **Session Management**: Continue flow restarting from Step 1 instead of preserving current step after logout/login

---

*Generated: 2025-09-11*
*Purpose: Complete debugging reference for LOGEN v2 AI workflow issues*