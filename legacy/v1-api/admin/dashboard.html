<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Locod.AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .pulse-green { animation: pulseGreen 2s infinite; }
        @keyframes pulseGreen { 0%, 100% { background-color: #10b981; } 50% { background-color: #059669; } }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Main App -->
    <div x-data="adminApp()" x-init="init()" x-cloak class="min-h-screen">
        
        <!-- Login Screen -->
        <div x-show="!isAuthenticated" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">üéõÔ∏è Admin Portal</h1>
                    <p class="text-gray-600">Locod.AI - AI Queue Management</p>
                </div>

                <form @submit.prevent="login()" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" x-model="loginForm.email" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="admin@locod.ai">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                        <input type="password" x-model="loginForm.password" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>

                    <div x-show="loginError" class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex">
                            <div class="text-red-400">‚ö†Ô∏è</div>
                            <div class="ml-3">
                                <p class="text-sm text-red-800" x-text="loginError"></p>
                                <p x-show="attemptsLeft > 0" class="text-xs text-red-600 mt-1">
                                    Tentatives restantes: <span x-text="attemptsLeft"></span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <button type="submit" :disabled="isLoading"
                            :class="isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'"
                            class="w-full text-white py-3 px-4 rounded-lg font-medium transition-colors">
                        <span x-show="!isLoading">Se connecter</span>
                        <span x-show="isLoading">üîÑ Connexion...</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div x-show="isAuthenticated" class="min-h-screen">
            
            <!-- Header -->
            <header class="bg-white shadow-sm border-b">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <div class="flex items-center">
                            <h1 class="text-xl font-semibold text-gray-900">üéõÔ∏è Admin Locod.AI</h1>
                            <div class="ml-6 flex space-x-8">
                                <button @click="currentView = 'dashboard'"
                                        :class="currentView === 'dashboard' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                        class="border-b-2 py-4 px-1 text-sm font-medium transition-colors">
                                    üìä Dashboard
                                </button>
                                <button @click="currentView = 'queue'"
                                        :class="currentView === 'queue' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                        class="border-b-2 py-4 px-1 text-sm font-medium transition-colors">
                                    ü§ñ Queue IA
                                </button>
                            </div>
                        </div>

                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-600">
                                <span x-text="user?.name"></span> (<span x-text="user?.role"></span>)
                            </div>
                            <button @click="logout()" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard View -->
            <div x-show="currentView === 'dashboard'" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">üìà Dashboard</h2>
                    <p class="text-gray-600">Vue d'ensemble de l'activit√© IA</p>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                                    <span class="text-white text-sm">üìã</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">Total Demandes</p>
                                <p class="text-2xl font-semibold text-gray-900" x-text="stats.total_requests || 0"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                                    <span class="text-white text-sm">‚è≥</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">En Attente</p>
                                <p class="text-2xl font-semibold text-gray-900" x-text="stats.pending_requests || 0"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                    <span class="text-white text-sm">‚úÖ</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">Compl√©t√©es Aujourd'hui</p>
                                <p class="text-2xl font-semibold text-gray-900" x-text="stats.completed_today || 0"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                                    <span class="text-white text-sm">üí∞</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">Revenus Aujourd'hui</p>
                                <p class="text-2xl font-semibold text-gray-900" x-text="(stats.revenue_today || 0) + '‚Ç¨'"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">üîÑ Activit√© R√©cente</h3>
                    </div>
                    <div class="divide-y divide-gray-200">
                        <template x-for="activity in recentActivity" :key="activity.id">
                            <div class="px-6 py-4 flex items-center justify-between">
                                <div class="flex items-center">
                                    <div :class="getStatusColor(activity.status)" class="w-2 h-2 rounded-full mr-3"></div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">
                                            Demande #<span x-text="activity.id"></span> - <span x-text="activity.request_type"></span>
                                        </p>
                                        <p class="text-sm text-gray-500" x-text="activity.customer_name || 'Client anonyme'"></p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-medium" :class="getStatusTextColor(activity.status)" x-text="getStatusLabel(activity.status)"></p>
                                    <p class="text-xs text-gray-500" x-text="formatDate(activity.created_at)"></p>
                                </div>
                            </div>
                        </template>
                        <div x-show="!recentActivity?.length" class="px-6 py-8 text-center text-gray-500">
                            Aucune activit√© r√©cente
                        </div>
                    </div>
                </div>
            </div>

            <!-- Queue View -->
            <div x-show="currentView === 'queue'" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="mb-8 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">ü§ñ Queue IA</h2>
                        <p class="text-gray-600">Gestion des demandes de g√©n√©ration IA</p>
                    </div>
                    <button @click="loadQueue()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        üîÑ Actualiser
                    </button>
                </div>

                <!-- Filters -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
                            <select x-model="filters.status" @change="loadQueue()" 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                <option value="">Tous</option>
                                <option value="pending">En attente</option>
                                <option value="assigned">Assign√©e</option>
                                <option value="processing">En cours</option>
                                <option value="completed">Termin√©e</option>
                                <option value="rejected">Rejet√©e</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                            <select x-model="filters.request_type" @change="loadQueue()"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                <option value="">Tous</option>
                                <option value="services">Services</option>
                                <option value="content">Contenu</option>
                                <option value="images">Images</option>
                                <option value="full_site">Site complet</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Admin</label>
                            <select x-model="filters.admin_id" @change="loadQueue()"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                <option value="">Tous</option>
                                <option x-show="user" :value="user?.id" x-text="`Mes demandes (${user?.name || 'Admin'})`"></option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tri</label>
                            <select x-model="sortBy" @change="loadQueue()"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                <option value="created_at:DESC">Plus r√©cent</option>
                                <option value="created_at:ASC">Plus ancien</option>
                                <option value="priority:ASC">Priorit√© haute</option>
                                <option value="status:ASC">Statut</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Queue Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terminologie</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admin</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cr√©√©</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="request in queueRequests" :key="request.id">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                            #<span x-text="request.id"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900" x-text="request.customer_name || request.customer_email"></div>
                                            <div class="text-sm text-gray-500" x-text="request.site_name || (request.request_data ? request.request_data.siteName : null) || 'Site sans nom'"></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" 
                                                  x-text="request.request_type"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="request.terminology || '-'"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span :class="getStatusBadgeColor(request.status)" 
                                                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                                  x-text="getStatusLabel(request.status)"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" 
                                            x-text="request.admin_name || 'Non assign√©'"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" 
                                            x-text="formatDate(request.created_at)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button x-show="request.status !== 'completed'" 
                                                    @click="openProcessingModal(request)"
                                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mr-3">
                                                ü§ñ Traiter
                                            </button>
                                            <button x-show="request.status === 'completed'" 
                                                    @click="openProcessingModal(request)"
                                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 mr-3">
                                                ‚úÖ Voir R√©sultat
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="!queueRequests?.length && !isLoading">
                                    <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                        Aucune demande trouv√©e
                                    </td>
                                </tr>
                                <tr x-show="isLoading">
                                    <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                        üîÑ Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div x-show="pagination?.totalPages > 1" class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button @click="changePage(pagination.page - 1)" :disabled="pagination.page <= 1"
                                    class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                                Pr√©c√©dent
                            </button>
                            <button @click="changePage(pagination.page + 1)" :disabled="pagination.page >= pagination.totalPages"
                                    class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                                Suivant
                            </button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div>
                                <p class="text-sm text-gray-700">
                                    Affichage de <span x-text="(pagination.page - 1) * pagination.limit + 1"></span> √† 
                                    <span x-text="Math.min(pagination.page * pagination.limit, pagination.total)"></span> sur 
                                    <span x-text="pagination.total"></span> r√©sultats
                                </p>
                            </div>
                            <div>
                                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                    <button @click="changePage(pagination.page - 1)" :disabled="pagination.page <= 1"
                                            class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                        ‚Äπ
                                    </button>
                                    <template x-for="page in getPageNumbers()" :key="page">
                                        <button @click="changePage(page)" 
                                                :class="page === pagination.page ? 'bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'"
                                                class="relative inline-flex items-center px-4 py-2 border text-sm font-medium"
                                                x-text="page"></button>
                                    </template>
                                    <button @click="changePage(pagination.page + 1)" :disabled="pagination.page >= pagination.totalPages"
                                            class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                        ‚Ä∫
                                    </button>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Processing Modal -->
        <div x-show="processingModal.show" 
             x-cloak
             class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-medium text-gray-900">
                        ü§ñ Traitement IA - Demande #<span x-text="processingModal.request?.id"></span>
                    </h3>
                    <button @click="closeProcessingModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Suggested Prompt -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-4">üìã Prompt Sugg√©r√©</h4>
                        <div class="bg-white border rounded-lg p-3 mb-4">
                            <pre x-text="processingModal.suggestedPrompt" class="text-sm whitespace-pre-wrap text-gray-700"></pre>
                        </div>
                        <button @click="copyToClipboard(processingModal.suggestedPrompt)" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm w-full">
                            üìã Copier vers Claude/ChatGPT
                        </button>
                        
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <h5 class="font-medium text-gray-700 mb-2 text-sm">D√©tails</h5>
                            <div class="space-y-1 text-xs text-gray-600">
                                <div><strong>Site:</strong> <span x-text="processingModal.request?.request_data?.siteName || 'N/A'"></span></div>
                                <div><strong>Business:</strong> <span x-text="processingModal.request?.business_type"></span></div>
                                <div><strong>Type:</strong> <span x-text="processingModal.request?.request_type"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Processing Interface -->
                    <div class="space-y-4">
                        <!-- Content or Images based on request type -->
                        <div x-show="processingModal.request?.request_type !== 'images'">
                            <h4 class="font-medium text-gray-900 mb-3">ü§ñ R√©sultat IA</h4>
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-2">
                                <p class="text-xs text-gray-600">
                                    <strong>üîÑ Workflow:</strong> 
                                    1. Copiez le prompt ci-dessus
                                    2. Collez dans Claude/ChatGPT 
                                    3. Collez la r√©ponse ici
                                    4. Cliquez "Appliquer & Terminer"
                                </p>
                            </div>
                            <textarea x-model="processingModal.result" rows="14"
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 resize-none text-sm font-mono"
                                      placeholder="Collez ici la r√©ponse g√©n√©r√©e par Claude/ChatGPT...

Format JSON recommand√© pour un meilleur traitement automatique"
                                      @input="saveDraft()"></textarea>
                            <div x-show="processingModal.lastSaved" class="mt-1 text-xs text-gray-500">
                                üíæ Brouillon sauvegard√©: <span x-text="formatDate(processingModal.lastSaved)"></span>
                            </div>
                        </div>
                        
                        <!-- Image Upload Interface -->
                        <div x-show="processingModal.request?.request_type === 'images'">
                            <h4 class="font-medium text-gray-900 mb-3">üé® Images G√©n√©r√©es</h4>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                                <p class="text-sm text-yellow-800">
                                    <strong>‚ö†Ô∏è Important:</strong> G√©n√©rez les images selon les prompts, puis uploadez-les ici.
                                    Les images seront automatiquement renomm√©es avec le pr√©fixe du site.
                                </p>
                            </div>
                            
                            <!-- Image upload grid -->
                            <div class="grid grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                                <template x-for="(imageInfo, index) in processingModal.imagesList" :key="index">
                                    <div class="border border-gray-200 rounded-lg p-3">
                                        <div class="text-sm font-medium mb-1" x-text="imageInfo.label"></div>
                                        <div x-show="imageInfo.description" class="text-xs text-gray-600 mb-2" x-text="imageInfo.description"></div>
                                        <div class="text-xs text-gray-500 mb-2">
                                            <span class="text-gray-400">Nom final:</span> 
                                            <code class="bg-gray-100 px-1 rounded text-xs" x-text="imageInfo.filename"></code>
                                        </div>
                                        
                                        <!-- Upload area -->
                                        <div @drop="handleImageDrop($event, index)" 
                                             @dragover.prevent 
                                             @dragenter.prevent
                                             class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-gray-400 cursor-pointer" 
                                             @click="triggerFileUpload(index)">
                                            
                                            <template x-if="!processingModal.uploadedImages[index]">
                                                <div>
                                                    <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                    </svg>
                                                    <p class="text-xs text-gray-600">Cliquez ou glissez</p>
                                                </div>
                                            </template>
                                            
                                            <template x-if="processingModal.uploadedImages[index]">
                                                <div>
                                                    <img :src="processingModal.uploadedImages[index]" alt="" class="max-h-20 mx-auto mb-2">
                                                    <p class="text-xs text-green-600">‚úì Upload√©</p>
                                                </div>
                                            </template>
                                        </div>
                                        <input type="file" @change="handleImageUpload($event, index)" accept="image/*" class="hidden" :id="'imageInput-' + index">
                                    </div>
                                </template>
                            </div>
                            
                            <div x-show="processingModal.uploadedCount > 0" class="mt-4 text-sm text-gray-600">
                                Images upload√©es: <span x-text="processingModal.uploadedCount"></span> / <span x-text="processingModal.imagesList.length"></span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Co√ªt r√©el</label>
                                <input type="number" x-model="processingModal.actualCost" step="0.01"
                                       class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notes admin</label>
                                <input type="text" x-model="processingModal.notes"
                                       class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500"
                                       placeholder="Notes optionnelles">
                            </div>
                        </div>

                        <div class="flex justify-between pt-4">
                            <button @click="rejectRequest()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                                ‚ùå Rejeter
                            </button>
                            <div class="space-x-3">
                                <button @click="closeProcessingModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                                    Annuler
                                </button>
                                <button @click="saveDraft()" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    üíæ Sauvegarder Brouillon
                                </button>
                                <button @click="completeRequest()" 
                                        :disabled="!processingModal.result.trim()"
                                        :class="processingModal.result.trim() ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-400 cursor-not-allowed'"
                                        class="text-white px-6 py-2 rounded-lg font-medium">
                                    ‚úÖ Appliquer & Terminer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ Admin Dashboard Script Loading...');
        
        function adminApp() {
            console.log('üéØ AdminApp function called');
            return {
                // Authentication
                isAuthenticated: false,
                token: localStorage.getItem('admin_token') || null,
                user: null,
                
                // Login
                loginForm: { email: '', password: '' },
                loginError: '',
                attemptsLeft: 0,
                isLoading: false,
                
                // UI State
                currentView: 'dashboard',
                
                // Dashboard Data
                stats: {},
                recentActivity: [],
                
                // Queue Data
                queueRequests: [],
                pagination: {},
                filters: { status: '', request_type: '', admin_id: '' },
                sortBy: 'created_at:DESC',
                
                // Processing Modal
                processingModal: {
                    show: false,
                    request: null,
                    result: '',
                    actualCost: 2.00,
                    notes: '',
                    suggestedPrompt: '',
                    autoSaveInterval: null,
                    lastSaved: null,
                    imagesList: [],
                    uploadedImages: {},
                    uploadedCount: 0
                },
                
                async init() {
                    console.log('üîß AdminApp init called');
                    // Ensure modal is hidden on init
                    this.processingModal.show = false;
                    
                    if (this.token) {
                        try {
                            const response = await fetch('/admin/dashboard/stats', {
                                headers: { 'Authorization': `Bearer ${this.token}` }
                            });
                            
                            if (response.ok) {
                                this.isAuthenticated = true;
                                this.decodeToken();
                                await this.loadDashboard();
                                await this.loadQueue();
                            } else {
                                localStorage.removeItem('admin_token');
                                this.token = null;
                            }
                        } catch (error) {
                            console.error('Init error:', error);
                            localStorage.removeItem('admin_token');
                            this.token = null;
                        }
                    }
                },
                
                decodeToken() {
                    if (this.token) {
                        try {
                            const payload = JSON.parse(atob(this.token.split('.')[1]));
                            this.user = payload;
                        } catch (error) {
                            console.error('Token decode error:', error);
                        }
                    }
                },
                
                async login() {
                    this.isLoading = true;
                    this.loginError = '';
                    
                    try {
                        const response = await fetch('/admin/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.loginForm)
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.token = data.token;
                            this.user = data.user;
                            localStorage.setItem('admin_token', this.token);
                            this.isAuthenticated = true;
                            await this.loadDashboard();
                            await this.loadQueue();
                        } else {
                            this.loginError = data.error;
                            this.attemptsLeft = data.attemptsLeft || 0;
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                        this.loginError = 'Erreur de connexion';
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async logout() {
                    try {
                        await fetch('/admin/auth/logout', {
                            method: 'POST',
                            headers: { 
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                    
                    localStorage.removeItem('admin_token');
                    this.token = null;
                    this.user = null;
                    this.isAuthenticated = false;
                    this.loginForm = { email: '', password: '' };
                },
                
                async loadDashboard() {
                    try {
                        const response = await fetch('/admin/dashboard/stats', {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.stats = data.stats;
                            this.recentActivity = data.recent_activity || [];
                        }
                    } catch (error) {
                        console.error('Dashboard load error:', error);
                    }
                },
                
                async loadQueue(page = 1) {
                    console.log('üîÑ Loading queue data...');
                    this.isLoading = true;
                    
                    try {
                        const params = new URLSearchParams({
                            page,
                            limit: 20,
                            ...this.filters,
                            sort_by: this.sortBy.split(':')[0],
                            sort_order: this.sortBy.split(':')[1]
                        });
                        
                        const response = await fetch(`/admin/queue?${params}`, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.queueRequests = data.requests || [];
                            this.pagination = data.pagination;
                        } else {
                            console.error('‚ùå Queue load failed:', response.status, response.statusText);
                        }
                    } catch (error) {
                        console.error('Queue load error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                // Token validation helper
                validateToken() {
                    console.log('üîß Validating token...');
                    
                    // Check if token exists in Alpine.js context
                    if (!this.token) {
                        console.log('‚ùå No token in Alpine.js context');
                        
                        // Try to get from localStorage
                        const storedToken = localStorage.getItem('admin_token');
                        if (storedToken) {
                            console.log('üîß Found token in localStorage, updating Alpine context');
                            this.token = storedToken;
                            return true;
                        } else {
                            console.log('‚ùå No token in localStorage either');
                            return false;
                        }
                    }
                    
                    console.log('‚úÖ Token available in Alpine.js context');
                    return true;
                },
                
                openProcessingModal(request) {
                    this.processingModal.show = true;
                    this.processingModal.request = request;
                    this.processingModal.suggestedPrompt = this.generatePrompt(request);
                    this.processingModal.result = request.generated_content || '';
                    this.processingModal.actualCost = request.actual_cost || request.estimated_cost;
                    this.processingModal.notes = request.admin_notes || '';
                    
                    // Initialize image handling for image requests
                    if (request.request_type === 'images') {
                        this.initializeImagesList(request);
                    }
                    
                    // Load draft if exists
                    this.loadDraft(request.id);
                    
                    // Start auto-save
                    this.startAutoSave();
                    
                    // Let Alpine.js handle the display
                },
                
                initializeImagesList(request) {
                    const siteId = request.site_id || 'site';
                    const imagesNeeded = request.request_data?.imagesNeeded || {};
                    this.processingModal.imagesList = [];
                    this.processingModal.uploadedImages = {};
                    this.processingModal.uploadedCount = 0;
                    
                    // Add main images according to template structure
                    if (imagesNeeded.logo) {
                        this.processingModal.imagesList.push({
                            label: 'Logo Navigation (clair)',
                            filename: `${siteId}-logo-clair.png`,
                            type: 'logo',
                            description: 'Logo pour la navigation (fond clair)'
                        });
                    }
                    if (imagesNeeded.logoFooter) {
                        this.processingModal.imagesList.push({
                            label: 'Logo Footer (sombre)',
                            filename: `${siteId}-logo-sombre.png`,
                            type: 'logoFooter',
                            description: 'Logo pour le pied de page (fond sombre)'
                        });
                    }
                    if (imagesNeeded.hero) {
                        this.processingModal.imagesList.push({
                            label: 'Image Hero Banni√®re',
                            filename: `${siteId}-hero.png`,
                            type: 'hero',
                            description: 'Image d\'accueil principale (banni√®re hero)'
                        });
                    }
                    if (imagesNeeded.faviconLight) {
                        this.processingModal.imagesList.push({
                            label: 'Favicon Clair',
                            filename: `${siteId}-favicon-clair.png`,
                            type: 'faviconLight',
                            description: 'Ic√¥ne du site pour th√®me clair (32x32px)'
                        });
                    }
                    if (imagesNeeded.faviconDark) {
                        this.processingModal.imagesList.push({
                            label: 'Favicon Sombre',
                            filename: `${siteId}-favicon-sombre.png`,
                            type: 'faviconDark',
                            description: 'Ic√¥ne du site pour th√®me sombre (32x32px)'
                        });
                    }
                    
                    // Add service images (following template pattern: siteId-services-1.png)
                    if (imagesNeeded.services && Array.isArray(imagesNeeded.services)) {
                        imagesNeeded.services.forEach((service, index) => {
                            this.processingModal.imagesList.push({
                                label: `Service: ${service}`,
                                filename: `${siteId}-services-${index + 1}.png`,
                                type: `service_${index}`,
                                description: `Image pour le service "${service}"`
                            });
                        });
                    }
                    
                    // Add blog images (following template pattern: blog/images/article-name.png)
                    if (imagesNeeded.blog && Array.isArray(imagesNeeded.blog)) {
                        imagesNeeded.blog.forEach((article, index) => {
                            // Create slug from article title for filename
                            const slug = article.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
                            this.processingModal.imagesList.push({
                                label: `Blog: ${article}`,
                                filename: `blog/images/${slug}.png`,
                                type: `blog_${index}`,
                                description: `Image d'article pour "${article}"`
                            });
                        });
                    }
                },
                
                triggerFileUpload(index) {
                    console.log(`üìÅ Triggering file upload for index ${index}`);
                    const fileInput = document.getElementById(`imageInput-${index}`);
                    if (fileInput) {
                        fileInput.click();
                    } else {
                        console.error(`‚ùå Could not find file input with id: imageInput-${index}`);
                    }
                },
                
                handleImageUpload(event, index) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('‚ùå Seuls les fichiers image sont accept√©s');
                        return;
                    }
                    
                    // Validate file size (10MB max)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('‚ùå Fichier trop volumineux (max 10MB)');
                        return;
                    }
                    
                    console.log(`üìÅ Uploading image ${index}: ${file.name} (${file.type}, ${(file.size/1024/1024).toFixed(2)}MB)`);
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        console.log(`‚úÖ Image ${index} loaded successfully`);
                        this.processingModal.uploadedImages[index] = e.target.result;
                        this.processingModal.uploadedCount = Object.keys(this.processingModal.uploadedImages).length;
                        this.saveDraft();
                    };
                    reader.onerror = (e) => {
                        console.error('‚ùå Error reading file:', e);
                        alert('‚ùå Erreur lors de la lecture du fichier');
                    };
                    reader.readAsDataURL(file);
                },
                
                handleImageDrop(event, index) {
                    console.log(`üéØ File dropped for index ${index}`);
                    event.preventDefault();
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        console.log(`üìÅ Processing ${files.length} dropped file(s)`);
                        const fakeEvent = { target: { files: files } };
                        this.handleImageUpload(fakeEvent, index);
                    } else {
                        console.log('‚ùå No files in drop event');
                    }
                },
                
                closeProcessingModal() {
                    console.log('‚ùå closeProcessingModal called');
                    this.stopAutoSave();
                    this.processingModal.show = false;
                },

                generatePrompt(request) {
                    const businessType = request.business_type || 'Business';
                    const terminology = request.terminology || 'services';
                    const siteName = request.request_data?.siteName || 'votre entreprise';
                    const slogan = request.request_data?.slogan || '';
                    const description = request.request_data?.businessDescription || '';
                    const city = request.request_data?.city || 'France';
                    
                    // Check if it's an image generation request
                    if (request.request_type === 'images') {
                        return this.generateImagePrompts(request);
                    }
                    
                    return `G√©n√®re TOUT le contenu textuel pour un site de ${businessType}.

Informations du site:
- Nom: ${siteName}
- Business: ${businessType}
- Slogan: ${slogan}
- Terminologie: ${terminology} (services/activit√©s/cours/interventions/sp√©cialit√©s)
- Description: ${description}
- Localisation: ${city}

Instructions:
- G√©n√®re du contenu professionnel, authentique et adapt√© au business
- Utilise la terminologie sp√©cifique (${terminology})
- Reste coh√©rent dans le ton et le style
- Format JSON strict, directement applicable

FORMAT JSON REQUIS:
{
  "hero": {
    "title": "Titre accrocheur (max 60 caract√®res)",
    "subtitle": "Sous-titre descriptif", 
    "description": "Description engageante (2-3 phrases)"
  },
  "services": [
    {
      "title": "Nom du service 1",
      "description": "Description d√©taill√©e du service",
      "features": ["Caract√©ristique 1", "Caract√©ristique 2", "Caract√©ristique 3"]
    },
    {
      "title": "Nom du service 2", 
      "description": "Description d√©taill√©e du service",
      "features": ["Caract√©ristique 1", "Caract√©ristique 2", "Caract√©ristique 3"]
    },
    {
      "title": "Nom du service 3",
      "description": "Description d√©taill√©e du service", 
      "features": ["Caract√©ristique 1", "Caract√©ristique 2", "Caract√©ristique 3"]
    },
    {
      "title": "Nom du service 4",
      "description": "Description d√©taill√©e du service",
      "features": ["Caract√©ristique 1", "Caract√©ristique 2", "Caract√©ristique 3"]
    },
    {
      "title": "Nom du service 5",
      "description": "Description d√©taill√©e du service",
      "features": ["Caract√©ristique 1", "Caract√©ristique 2", "Caract√©ristique 3"]
    }
  ],
  "about": {
    "title": "√Ä propos de [NOM_SITE]",
    "subtitle": "Sous-titre engageant",
    "description": "Pr√©sentation de l'entreprise (3-4 phrases)",
    "values": [
      {"title": "Valeur 1", "description": "Description de la valeur 1"},
      {"title": "Valeur 2", "description": "Description de la valeur 2"},
      {"title": "Valeur 3", "description": "Description de la valeur 3"},
      {"title": "Valeur 4", "description": "Description de la valeur 4"}
    ]
  },
  "testimonials": [
    {
      "text": "T√©moignage authentique et sp√©cifique (2-3 phrases)",
      "name": "Pr√©nom Nom",
      "position": "Poste, Entreprise",
      "rating": 5
    },
    {
      "text": "T√©moignage authentique et sp√©cifique (2-3 phrases)",
      "name": "Pr√©nom Nom", 
      "position": "Poste, Entreprise",
      "rating": 5
    },
    {
      "text": "T√©moignage authentique et sp√©cifique (2-3 phrases)",
      "name": "Pr√©nom Nom",
      "position": "Poste, Entreprise", 
      "rating": 5
    }
  ],
  "faq": [
    {"question": "Question fr√©quente sp√©cifique 1?", "answer": "R√©ponse d√©taill√©e et professionnelle"},
    {"question": "Question fr√©quente sp√©cifique 2?", "answer": "R√©ponse d√©taill√©e et professionnelle"},
    {"question": "Question fr√©quente sp√©cifique 3?", "answer": "R√©ponse d√©taill√©e et professionnelle"},
    {"question": "Question fr√©quente sp√©cifique 4?", "answer": "R√©ponse d√©taill√©e et professionnelle"},
    {"question": "Question fr√©quente sp√©cifique 5?", "answer": "R√©ponse d√©taill√©e et professionnelle"},
    {"question": "Question fr√©quente sp√©cifique 6?", "answer": "R√©ponse d√©taill√©e et professionnelle"}
  ],
  "servicesPage": {
    "subtitle": "Sous-titre pour la page des [TERMINOLOGIE]",
    "ctaTitle": "Titre call-to-action engageant",
    "ctaDescription": "Description motivante pour l'action"
  },
  "seo": {
    "title": "Titre SEO optimis√© (max 60 caract√®res)",
    "description": "Meta description optimis√©e (150-160 caract√®res)",
    "keywords": ["mot-cl√© 1", "mot-cl√© 2", "mot-cl√© 3", "mot-cl√© 4", "mot-cl√© 5"]
  },
  "terminology": "` + terminology + `",
  "blog": {
    "articles": [
      {
        "title": "Titre article 1 pertinent pour ` + businessType + `",
        "excerpt": "R√©sum√© accrocheur de l'article (2-3 phrases)",
        "content": "Introduction de l'article (3-4 paragraphes)",
        "category": "Cat√©gorie appropri√©e",
        "tags": ["tag1", "tag2", "tag3"]
      },
      {
        "title": "Titre article 2 pertinent pour ` + businessType + `",
        "excerpt": "R√©sum√© accrocheur de l'article (2-3 phrases)",
        "content": "Introduction de l'article (3-4 paragraphes)",
        "category": "Cat√©gorie appropri√©e",
        "tags": ["tag1", "tag2", "tag3"]
      },
      {
        "title": "Titre article 3 pertinent pour ` + businessType + `",
        "excerpt": "R√©sum√© accrocheur de l'article (2-3 sentences)",
        "content": "Introduction de l'article (3-4 paragraphes)",
        "category": "Cat√©gorie appropri√©e",
        "tags": ["tag1", "tag2", "tag3"]
      }
    ]
  }
}

G√©n√®re maintenant le contenu complet:`;
                },

                generateImagePrompts(request) {
                    const siteId = request.site_id || 'site';
                    const siteName = request.request_data?.siteName || 'entreprise';
                    const businessType = request.business_type || 'business';
                    const style = request.request_data?.style || 'modern';
                    const colors = request.request_data?.colors || {};
                    const description = request.request_data?.businessDescription || '';
                    const slogan = request.request_data?.slogan || '';
                    const imagesNeeded = request.request_data?.imagesNeeded || {};
                    const approach = request.request_data?.approach || 'ai';
                    
                    let prompts = `üé® PROMPTS DE G√âN√âRATION D'IMAGES
                    
Site: ${siteName}
Business: ${businessType}
Style: ${style}
Couleurs: ${colors.primary || '#3B82F6'}, ${colors.secondary || '#60A5FA'}
Approche: ${approach === 'mixed' ? 'MIXTE - G√©n√©rer seulement les images manquantes' : 'COMPL√àTE'}

‚ö†Ô∏è IMPORTANT: G√©n√©rez les images puis uploadez-les dans l'interface ci-dessous.
L'application renommera automatiquement les fichiers.

üìå IMAGES √Ä G√âN√âRER:
`;

                    // Check which images are already uploaded
                    const uploadedImages = request.request_data?.uploadedImages || {};
                    let hasImages = false;
                    let imageNumber = 1;
                    
                    // Only show prompts for images that need to be generated and are not uploaded
                    if (imagesNeeded.logo && !uploadedImages.logo) {
                        hasImages = true;
                        prompts += `
${imageNumber}. Logo principal (navigation)
Prompt: "Create a modern logo for ${siteName}, a ${businessType} company. Style: ${style}, clean design for light background. Include text: ${siteName}. Colors: ${colors.primary}, ${colors.secondary}"
`;
                        imageNumber++;
                    } else if (uploadedImages.logo) {
                        prompts += `
‚úì Logo principal - D√âJ√Ä UPLOAD√â par l'utilisateur`;
                    }
                    
                    if (imagesNeeded.logoFooter && !uploadedImages.logoFooter) {
                        hasImages = true;
                        prompts += `
${imageNumber}. Logo footer (version sombre)
Prompt: "Create the same logo as above but optimized for dark background. Light/white version of the ${siteName} logo"
`;
                        imageNumber++;
                    } else if (uploadedImages.logoFooter) {
                        prompts += `
‚úì Logo footer - D√âJ√Ä UPLOAD√â par l'utilisateur`;
                    }
                    
                    if (imagesNeeded.hero && !uploadedImages.hero) {
                        hasImages = true;
                        prompts += `
${imageNumber}. Image banni√®re hero
Prompt: "Create a hero banner image for ${siteName} website. Business: ${businessType}. Style: ${style}, professional and engaging. Theme: ${description || slogan}. No text in image."
`;
                        imageNumber++;
                    } else if (uploadedImages.hero) {
                        prompts += `
‚úì Image hero - D√âJ√Ä UPLOAD√âE par l'utilisateur`;
                    }
                    
                    if (imagesNeeded.faviconLight && !uploadedImages.faviconLight) {
                        hasImages = true;
                        prompts += `
${imageNumber}. Favicon clair
Prompt: "Create a minimal favicon icon for ${siteName}. Simple symbol representing ${businessType}. Style: ${style}, for light theme. Size: 32x32px"
`;
                        imageNumber++;
                    }
                    
                    if (imagesNeeded.faviconDark) {
                        prompts += `
${imageNumber}. Favicon sombre  
Prompt: "Same favicon as above but for dark theme. Light/white version."
`;
                        imageNumber++;
                    }

                    // Service images
                    if (imagesNeeded.services && imagesNeeded.services.length > 0) {
                        prompts += `\nüìã IMAGES SERVICES:\n`;
                        imagesNeeded.services.forEach((service, index) => {
                            prompts += `
${imageNumber}. Image pour "${service}"
Prompt: "Create an illustration for '${service}' service. Business context: ${businessType}. Style: ${style}, professional. No text in image."
`;
                            imageNumber++;
                        });
                    }
                    
                    // Blog images
                    if (imagesNeeded.blog && imagesNeeded.blog.length > 0) {
                        prompts += `\nüìù IMAGES BLOG:\n`;
                        imagesNeeded.blog.forEach((article, index) => {
                            prompts += `
${imageNumber}. Image pour article "${article}"
Prompt: "Create a blog header image for article about '${article}'. Business context: ${businessType}. Style: ${style}, engaging. No text in image."
`;
                            imageNumber++;
                        });
                    }
                    
                    prompts += `\n\nüîÑ PROCESSUS:
1. G√©n√©rez chaque image selon les prompts
2. Uploadez les images dans l'interface ci-dessous
3. L'application renommera automatiquement avec le pr√©fixe ${siteId}-
4. Cliquez "Terminer" quand toutes les images sont upload√©es`;

                    // Blog images
                    if (imagesNeeded.blog && imagesNeeded.blog.length > 0) {
                        prompts += `\nüìù IMAGES BLOG:\n`;
                        imagesNeeded.blog.forEach((article, index) => {
                            prompts += `
${index + 6 + (imagesNeeded.services?.length || 0)}. ${article} ‚Üí Renommer: blog-${index + 1}.jpg
Prompt: "Create a blog header image for article: '${article}'. Business context: ${businessType}. Style: ${style}, engaging. No text in image."
`;
                        });
                    }

                    prompts += `\n
üìÅ UPLOAD INSTRUCTIONS:
1. G√©n√©rer chaque image avec le prompt correspondant
2. Renommer EXACTEMENT comme indiqu√©
3. Uploader toutes les images
4. Format: PNG pour logos/favicons, JPG pour photos
5. Taille recommand√©e: Hero (1200x600), Services (400x300), Blog (800x400)

‚úÖ Une fois toutes les images upload√©es et renomm√©es, marquer comme "Termin√©"`;

                    return prompts;
                },

                async assignRequest(requestId) {
                    console.log('üîß Assign button clicked for request:', requestId);
                    console.log('üîß Request ID type:', typeof requestId);
                    console.log('üîß Token available:', !!this.token);
                    
                    if (!requestId) {
                        console.log('‚ùå No request ID provided');
                        alert('‚ùå Erreur: ID de demande manquant');
                        return;
                    }
                    
                    if (!this.validateToken()) {
                        alert('‚ùå Token manquant - veuillez vous reconnecter');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/admin/queue/${requestId}/assign`, {
                            method: 'PUT',
                            headers: { 
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        console.log('üîß Assign response status:', response.status);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('‚úÖ Assign successful:', data);
                            await this.loadQueue();
                            await this.loadDashboard();
                        } else {
                            const errorData = await response.json();
                            console.error('‚ùå Assign failed:', errorData);
                            alert(`‚ùå Erreur d'assignation: ${errorData.message || 'Erreur inconnue'}`);
                        }
                    } catch (error) {
                        console.error('‚ùå Assign error:', error);
                        alert(`‚ùå Erreur r√©seau: ${error.message}`);
                    }
                },
                
                async startProcessing(requestId) {
                    console.log('üöÄ Start button clicked for request:', requestId);
                    console.log('üîß Request ID type:', typeof requestId);
                    console.log('üîß Token available:', !!this.token);
                    
                    if (!requestId) {
                        console.log('‚ùå No request ID provided');
                        alert('‚ùå Erreur: ID de demande manquant');
                        return;
                    }
                    
                    if (!this.validateToken()) {
                        alert('‚ùå Token manquant - veuillez vous reconnecter');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/admin/queue/${requestId}/start`, {
                            method: 'PUT',
                            headers: { 
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        console.log('üöÄ Start response status:', response.status);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('‚úÖ Start successful:', data);
                            await this.viewRequest(requestId);
                        } else {
                            const errorData = await response.json();
                            console.error('‚ùå Start failed:', errorData);
                            alert(`‚ùå Erreur de d√©marrage: ${errorData.message || 'Erreur inconnue'}`);
                        }
                    } catch (error) {
                        console.error('‚ùå Start processing error:', error);
                        alert(`‚ùå Erreur r√©seau: ${error.message}`);
                    }
                },
                
                async viewRequest(requestId) {
                    console.log('üëÅÔ∏è View button clicked for request:', requestId);
                    console.log('üîß Request ID type:', typeof requestId);
                    console.log('üîß Token available:', !!this.token);
                    
                    if (!requestId) {
                        console.log('‚ùå No request ID provided');
                        alert('‚ùå Erreur: ID de demande manquant');
                        return;
                    }
                    
                    if (!this.validateToken()) {
                        alert('‚ùå Token manquant - veuillez vous reconnecter');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/admin/queue/${requestId}`, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        
                        console.log('üëÅÔ∏è View response status:', response.status);
                        
                        if (response.ok) {
                            const request = await response.json();
                            console.log('‚úÖ View successful, opening modal for:', request.id);
                            
                            this.processingModal.request = request;
                            this.processingModal.result = '';
                            this.processingModal.actualCost = request.estimated_cost;
                            this.processingModal.notes = '';
                            this.processingModal.show = true;
                            
                            console.log('üîß Modal should be visible:', this.processingModal.show);
                        } else {
                            const errorData = await response.json();
                            console.error('‚ùå View failed:', errorData);
                            alert(`‚ùå Erreur de visualisation: ${errorData.message || 'Erreur inconnue'}`);
                        }
                    } catch (error) {
                        console.error('‚ùå View request error:', error);
                        alert(`‚ùå Erreur r√©seau: ${error.message}`);
                    }
                },
                
                async completeRequest() {
                    // Check if it's an image request
                    if (this.processingModal.request?.request_type === 'images') {
                        // Verify all images are uploaded
                        if (this.processingModal.uploadedCount < this.processingModal.imagesList.length) {
                            alert(`Veuillez uploader toutes les images (${this.processingModal.uploadedCount}/${this.processingModal.imagesList.length})`);
                            return;
                        }
                        
                        // Prepare image data with proper filenames
                        const imageData = {};
                        this.processingModal.imagesList.forEach((imageInfo, index) => {
                            if (this.processingModal.uploadedImages[index]) {
                                imageData[imageInfo.type] = {
                                    filename: imageInfo.filename,
                                    data: this.processingModal.uploadedImages[index]
                                };
                            }
                        });
                        
                        try {
                            const response = await fetch(`/admin/queue/${this.processingModal.request.id}/complete`, {
                                method: 'PUT',
                                headers: { 
                                    'Authorization': `Bearer ${this.token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    generated_content: imageData,
                                    actual_cost: this.processingModal.actualCost,
                                    admin_notes: this.processingModal.notes,
                                    content_type: 'images'
                                })
                            });
                            
                            if (response.ok) {
                                this.clearDraft();
                                this.stopAutoSave();
                                this.processingModal.show = false;
                                await this.loadQueue();
                                await this.loadDashboard();
                                this.showToast('üé® Images upload√©es avec succ√®s', 'success');
                            }
                        } catch (error) {
                            console.error('Complete image request error:', error);
                            alert('Erreur lors de l\'upload des images');
                        }
                    } else {
                        // Text content request
                        if (!this.processingModal.result.trim()) return;
                        
                        try {
                            // Try to parse as JSON, fallback to plain text
                            let generatedContent;
                            try {
                                generatedContent = JSON.parse(this.processingModal.result);
                            } catch {
                                generatedContent = { content: this.processingModal.result };
                            }
                            
                            const response = await fetch(`/admin/queue/${this.processingModal.request.id}/complete`, {
                                method: 'PUT',
                                headers: { 
                                    'Authorization': `Bearer ${this.token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    generated_content: generatedContent,
                                    actual_cost: this.processingModal.actualCost,
                                    admin_notes: this.processingModal.notes
                                })
                            });
                            
                            if (response.ok) {
                                this.clearDraft();
                                this.stopAutoSave();
                                this.processingModal.show = false;
                                await this.loadQueue();
                                await this.loadDashboard();
                                this.showToast('üéâ Demande termin√©e avec succ√®s', 'success');
                            }
                        } catch (error) {
                            console.error('Complete request error:', error);
                        }
                    }
                },
                
                async rejectRequest() {
                    if (!confirm('√ätes-vous s√ªr de vouloir rejeter cette demande ?')) return;
                    
                    try {
                        const response = await fetch(`/admin/queue/${this.processingModal.request.id}/reject`, {
                            method: 'PUT',
                            headers: { 
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                admin_notes: this.processingModal.notes
                            })
                        });
                        
                        if (response.ok) {
                            this.clearDraft();
                            this.stopAutoSave();
                            this.processingModal.show = false;
                            await this.loadQueue();
                            await this.loadDashboard();
                            this.showToast('‚ùå Demande rejet√©e', 'error');
                        }
                    } catch (error) {
                        console.error('Reject request error:', error);
                    }
                },
                
                changePage(page) {
                    if (page >= 1 && page <= this.pagination.totalPages) {
                        this.loadQueue(page);
                    }
                },
                
                getPageNumbers() {
                    const pages = [];
                    const total = this.pagination.totalPages;
                    const current = this.pagination.page;
                    
                    for (let i = Math.max(1, current - 2); i <= Math.min(total, current + 2); i++) {
                        pages.push(i);
                    }
                    
                    return pages;
                },
                
                getStatusColor(status) {
                    const colors = {
                        pending: 'bg-yellow-400',
                        assigned: 'bg-blue-400',
                        processing: 'bg-purple-400',
                        completed: 'bg-green-400',
                        rejected: 'bg-red-400'
                    };
                    return colors[status] || 'bg-gray-400';
                },
                
                getStatusTextColor(status) {
                    const colors = {
                        pending: 'text-yellow-600',
                        assigned: 'text-blue-600',
                        processing: 'text-purple-600',
                        completed: 'text-green-600',
                        rejected: 'text-red-600'
                    };
                    return colors[status] || 'text-gray-600';
                },
                
                getStatusBadgeColor(status) {
                    const colors = {
                        pending: 'bg-yellow-100 text-yellow-800',
                        assigned: 'bg-blue-100 text-blue-800',
                        processing: 'bg-purple-100 text-purple-800',
                        completed: 'bg-green-100 text-green-800',
                        rejected: 'bg-red-100 text-red-800'
                    };
                    return colors[status] || 'bg-gray-100 text-gray-800';
                },
                
                getStatusLabel(status) {
                    const labels = {
                        pending: 'En attente',
                        assigned: 'Assign√©e',
                        processing: 'En cours',
                        completed: 'Termin√©e',
                        rejected: 'Rejet√©e'
                    };
                    return labels[status] || status;
                },
                
                formatDate(dateString) {
                    if (!dateString) return '-';
                    const date = new Date(dateString);
                    return date.toLocaleString('fr-FR', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                
                loadDraft(requestId) {
                    const draftKey = `admin_draft_${requestId}`;
                    const draft = localStorage.getItem(draftKey);
                    if (draft) {
                        try {
                            const data = JSON.parse(draft);
                            this.processingModal.result = data.result || '';
                            this.processingModal.notes = data.notes || '';
                            this.processingModal.actualCost = data.actualCost || this.processingModal.actualCost;
                            this.processingModal.lastSaved = data.timestamp || null;
                            console.log('‚úÖ Draft loaded for request:', requestId);
                            this.showToast('üìÑ Brouillon r√©cup√©r√©', 'info');
                        } catch (error) {
                            console.error('Error loading draft:', error);
                        }
                    }
                },
                
                saveDraft() {
                    if (!this.processingModal.request) return;
                    
                    const draftKey = `admin_draft_${this.processingModal.request.id}`;
                    const draft = {
                        result: this.processingModal.result,
                        notes: this.processingModal.notes,
                        actualCost: this.processingModal.actualCost,
                        timestamp: new Date().toISOString()
                    };
                    
                    try {
                        localStorage.setItem(draftKey, JSON.stringify(draft));
                        this.processingModal.lastSaved = draft.timestamp;
                        console.log('üíæ Draft saved for request:', this.processingModal.request.id);
                    } catch (error) {
                        console.error('Error saving draft:', error);
                    }
                },
                
                startAutoSave() {
                    // Clear existing interval
                    if (this.processingModal.autoSaveInterval) {
                        clearInterval(this.processingModal.autoSaveInterval);
                    }
                    
                    // Auto-save every 30 seconds
                    this.processingModal.autoSaveInterval = setInterval(() => {
                        if (this.processingModal.show && this.processingModal.request) {
                            this.saveDraft();
                        }
                    }, 30000);
                },
                
                stopAutoSave() {
                    if (this.processingModal.autoSaveInterval) {
                        clearInterval(this.processingModal.autoSaveInterval);
                        this.processingModal.autoSaveInterval = null;
                    }
                },
                
                clearDraft() {
                    if (!this.processingModal.request) return;
                    
                    const draftKey = `admin_draft_${this.processingModal.request.id}`;
                    localStorage.removeItem(draftKey);
                    this.processingModal.lastSaved = null;
                },
                
                async copyToClipboard(text) {
                    console.log('üìã copyToClipboard called with text:', text?.substring(0, 50));
                    try {
                        if (navigator.clipboard && window.isSecureContext) {
                            await navigator.clipboard.writeText(text);
                            this.showToast('‚úÖ Prompt copi√© dans le presse-papiers', 'success');
                        } else {
                            // Fallback for older browsers or non-HTTPS
                            const textArea = document.createElement('textarea');
                            textArea.value = text;
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            try {
                                document.execCommand('copy');
                                this.showToast('‚úÖ Prompt copi√© dans le presse-papiers', 'success');
                            } catch (err) {
                                this.showToast('‚ùå Erreur lors de la copie', 'error');
                            }
                            document.body.removeChild(textArea);
                        }
                    } catch (err) {
                        console.error('Copy to clipboard failed:', err);
                        this.showToast('‚ùå Erreur lors de la copie', 'error');
                    }
                },
                
                showToast(message, type = 'info') {
                    // Create toast notification
                    const toast = document.createElement('div');
                    toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white font-medium transform transition-all duration-300 translate-x-full opacity-0 ${
                        type === 'success' ? 'bg-green-600' : 
                        type === 'error' ? 'bg-red-600' : 
                        'bg-blue-600'
                    }`;
                    toast.textContent = message;
                    
                    document.body.appendChild(toast);
                    
                    // Animate in
                    setTimeout(() => {
                        toast.classList.remove('translate-x-full', 'opacity-0');
                    }, 10);
                    
                    // Animate out and remove
                    setTimeout(() => {
                        toast.classList.add('translate-x-full', 'opacity-0');
                        setTimeout(() => {
                            document.body.removeChild(toast);
                        }, 300);
                    }, 3000);
                }
            }
        }
    </script>

</body>
</html>